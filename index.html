<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ëª½ë‘¥ì´ í‚¤ìš°ê¸° (ì›¹)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#121a2a;
      --panel2:#0f1626;
      --text:#e8eefc;
      --muted:#a9b6d6;
      --accent:#6aa7ff;
      --good:#45d483;
      --warn:#ffcd4a;
      --bad:#ff5c77;
      --line:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1200px 600px at 20% 0%, #132045 0%, var(--bg) 60%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
      line-height:1.35;
    }
    header{
      padding:20px 18px 10px;
      max-width:1100px; margin:0 auto;
      display:flex; gap:14px; align-items:flex-end; justify-content:space-between;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    .title h1{margin:0; font-size:20px; letter-spacing:-.4px}
    .title .sub{color:var(--muted); font-size:13px}
    .topbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding:8px 10px; border-radius:999px;
      font-size:13px; color:var(--text);
      display:flex; gap:8px; align-items:center;
    }
    .pill b{font-variant-numeric: tabular-nums}
    .wrap{max-width:1100px; margin:0 auto; padding:10px 18px 22px;}
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    .card .hd .h{
      display:flex; flex-direction:column; gap:3px;
    }
    .card .hd .h .t{font-weight:700}
    .card .hd .h .d{font-size:12px; color:var(--muted)}
    .card .bd{padding:14px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 240px}
    .mono{font-variant-numeric: tabular-nums}
    .bar{
      height:10px; border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar > i{
      display:block; height:100%;
      background: linear-gradient(90deg, rgba(106,167,255,.9), rgba(106,167,255,.3));
      width:0%;
    }
    .bar.good > i{background: linear-gradient(90deg, rgba(69,212,131,.95), rgba(69,212,131,.25));}
    .bar.warn > i{background: linear-gradient(90deg, rgba(255,205,74,.95), rgba(255,205,74,.25));}
    .bar.bad  > i{background: linear-gradient(90deg, rgba(255,92,119,.95), rgba(255,92,119,.25));}

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .stats{grid-template-columns:1fr}
    }
    .stat{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{font-weight:700}
    .stat .v small{font-weight:600; color:var(--muted)}
    .btns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width:520px){
      .btns{grid-template-columns:1fr}
    }
    button{
      appearance:none; border:0; cursor:pointer;
      border-radius:14px;
      padding:12px 12px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      font-weight:700;
      text-align:left;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button:active{transform: translateY(1px)}
    button[disabled]{opacity:.45; cursor:not-allowed}
    .btnNote{display:block; margin-top:4px; font-size:12px; color:var(--muted); font-weight:600}
    .accent{border-color: rgba(106,167,255,.35); background: rgba(106,167,255,.12)}
    .goodBtn{border-color: rgba(69,212,131,.30); background: rgba(69,212,131,.10)}
    .warnBtn{border-color: rgba(255,205,74,.28); background: rgba(255,205,74,.10)}
    .badBtn{border-color: rgba(255,92,119,.28); background: rgba(255,92,119,.10)}
    .mini{
      font-size:12px; color:var(--muted);
    }
    .log{
      height:250px; overflow:auto;
      padding:10px; border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      font-size:12px;
    }
    .log p{margin:0 0 6px}
    .tag{
      display:inline-block; padding:2px 8px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      font-size:11px; color:var(--muted);
      margin-right:6px;
    }
    .shop{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      border-radius:14px;
      padding:10px;
      display:flex; gap:10px; justify-content:space-between; align-items:center;
    }
    .item .info{display:flex; flex-direction:column; gap:4px}
    .item .name{font-weight:800}
    .item .desc{font-size:12px; color:var(--muted)}
    .item .cost{font-size:12px; color:var(--muted)}
    .item .buy{min-width:110px; text-align:center}
    .split{
      display:grid; grid-template-columns: 1fr;
      gap:10px;
    }
    .canvasWrap{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    canvas{
      width:160px; height:160px; border-radius:18px;
      border:1px solid var(--line);
      background: radial-gradient(100px 100px at 30% 20%, rgba(106,167,255,.25), rgba(0,0,0,.18));
    }
    .sideInfo{flex:1 1 220px}
    .kv{
      display:flex; justify-content:space-between; gap:10px;
      padding:8px 10px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      margin-bottom:8px;
      font-size:13px;
    }
    .kv .k{color:var(--muted)}
    .kv .v{font-weight:800}
    .footerBtns{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }
    .smallBtn{
      padding:10px 10px; border-radius:12px; font-weight:800; font-size:13px;
    }
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      max-width:min(92vw, 720px);
      box-shadow: var(--shadow);
    }
    a.fake{color:var(--accent); text-decoration:none; border-bottom:1px dashed rgba(106,167,255,.35)}
    .rightMini{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>ëª½ë‘¥ì´ í‚¤ìš°ê¸°</h1>
    <div class="sub">ì—°ë§ˆ â†’ ì „íˆ¬ â†’ ì—…ê·¸ë ˆì´ë“œ â†’ ë” ê°•í•œ ëª½ë‘¥ì´ë¡œ ì„±ì¥!</div>
  </div>
  <div class="topbar">
    <div class="pill">ğŸª™ ì½”ì¸ <b id="coins" class="mono">0</b></div>
    <div class="pill">ğŸ’ ì ¬ <b id="gems" class="mono">0</b></div>
    <div class="pill">â­ ëª…ì„± <b id="fame" class="mono">0</b></div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: ëª½ë‘¥ì´/í–‰ë™ -->
    <section class="card">
      <div class="hd">
        <div class="h">
          <div class="t">ë‚´ ëª½ë‘¥ì´</div>
          <div class="d">ë ˆë²¨ì—…ê³¼ ì—…ê·¸ë ˆì´ë“œë¡œ ìŠ¤íƒ¯ì´ ë°”ë€ë‹ˆë‹¤.</div>
        </div>
        <div class="rightMini mono" id="saveHint">ìë™ ì €ì¥ë¨</div>
      </div>
      <div class="bd">
        <div class="canvasWrap">
          <canvas id="cv" width="320" height="320" aria-label="ëª½ë‘¥ì´"></canvas>
          <div class="sideInfo">
            <div class="kv"><span class="k">ë“±ê¸‰</span><span class="v" id="grade">ë‚˜ë¬´ ë§‰ëŒ€</span></div>
            <div class="kv"><span class="k">ë ˆë²¨</span><span class="v mono" id="level">1</span></div>
            <div class="kv"><span class="k">ê³µê²©ë ¥</span><span class="v mono" id="power">1</span></div>
            <div class="kv"><span class="k">ê³µê²©ì†ë„</span><span class="v mono" id="speed">1.00</span></div>
            <div class="kv"><span class="k">ì¹˜ëª…íƒ€</span><span class="v mono" id="crit">5% Ã—1.5</span></div>
            <div class="kv"><span class="k">ë‚´êµ¬ë„</span><span class="v mono" id="durTxt">100/100</span></div>

            <div class="mini">ê²½í—˜ì¹˜</div>
            <div class="bar" id="xpBar"><i></i></div>
            <div class="mini mono" id="xpTxt" style="margin-top:6px;">0 / 10</div>

            <div class="mini" style="margin-top:10px;">ë‚´êµ¬ë„</div>
            <div class="bar good" id="durBar"><i></i></div>
          </div>
        </div>

        <div class="btns">
          <button class="accent" id="btnTrain">
            ğŸ”¨ ì—°ë§ˆí•˜ê¸°
            <span class="btnNote">ê³µê²©ë ¥/ê²½í—˜ì¹˜ â†‘, ë‚´êµ¬ë„ â†“</span>
          </button>
          <button class="goodBtn" id="btnRest">
            ğŸ§° ìˆ˜ë¦¬í•˜ê¸°
            <span class="btnNote">ì½”ì¸ìœ¼ë¡œ ë‚´êµ¬ë„ íšŒë³µ</span>
          </button>
          <button class="warnBtn" id="btnBattle">
            ğŸ² ì „íˆ¬ ì‹œì‘
            <span class="btnNote">ìŠ¹ë¦¬ ì‹œ ì½”ì¸/ê²½í—˜ì¹˜ íšë“</span>
          </button>
          <button class="badBtn" id="btnFlee" disabled>
            ğŸƒ ë„ë§ì¹˜ê¸°
            <span class="btnNote">ì „íˆ¬ ì¤‘ ì¦‰ì‹œ ì¢…ë£Œ (ë³´ìƒ ê°ì†Œ)</span>
          </button>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="col">
            <div class="mini">ì „íˆ¬ ìƒíƒœ</div>
            <div class="stat" style="margin-top:8px;">
              <div>
                <div class="k">ì </div>
                <div class="v" id="enemyName">-</div>
              </div>
              <div style="min-width:140px;">
                <div class="k">ì  ì²´ë ¥</div>
                <div class="bar bad" id="enemyBar" style="margin-top:6px;"><i></i></div>
                <div class="mini mono" id="enemyHpTxt" style="margin-top:6px;">-</div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="mini">ë¡œê·¸</div>
            <div class="log" id="log" style="margin-top:8px;"></div>
          </div>
        </div>

        <div class="footerBtns">
          <button class="smallBtn" id="btnExport">ğŸ“¤ ì €ì¥ ë‚´ë³´ë‚´ê¸°</button>
          <button class="smallBtn" id="btnImport">ğŸ“¥ ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="smallBtn" id="btnReset" title="ì •ë§ ì´ˆê¸°í™”í•©ë‹ˆë‹¤">ğŸ§¨ ì´ˆê¸°í™”</button>
          <span class="mini">íŒ: ì—…ê·¸ë ˆì´ë“œëŠ” ì˜¤ë¥¸ìª½ â€œìƒì â€ì—ì„œ!</span>
        </div>
      </div>
    </section>

    <!-- RIGHT: ìƒì /ì—…ì  -->
    <aside class="card">
      <div class="hd">
        <div class="h">
          <div class="t">ìƒì </div>
          <div class="d">ì—…ê·¸ë ˆì´ë“œë¡œ ì„±ì¥ ì†ë„ë¥¼ ì˜¬ë¦¬ì„¸ìš”.</div>
        </div>
        <div class="rightMini">êµ¬ë§¤ëŠ” ì¦‰ì‹œ ë°˜ì˜</div>
      </div>
      <div class="bd">
        <div class="shop" id="shop"></div>

        <div style="height:14px;"></div>

        <div class="hd" style="margin:-14px -14px 12px; border-radius:14px; border:1px solid var(--line);">
          <div class="h">
            <div class="t">ì—…ì </div>
            <div class="d">ë‹¬ì„±í•˜ë©´ ë³´ìƒì„ ì¤ë‹ˆë‹¤.</div>
          </div>
          <div class="rightMini mono" id="achCount">0/0</div>
        </div>
        <div class="split" id="achs"></div>
        <div class="mini" style="margin-top:10px;">
          * ì´ ê²Œì„ì€ ë°ëª¨ìš©ì´ë¼ ë°¸ëŸ°ìŠ¤ëŠ” ê°€ë³ê²Œ ì¡ì•˜ìŠµë‹ˆë‹¤. ì›í•˜ë©´ â€œì „íˆ¬/ìƒì /ìŠ¤íƒ¯â€ ë” í™•ì¥í•´ ë“œë¦´ê²Œìš”.
        </div>
      </div>
    </aside>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ---------- Game Data ----------
  const GRADES = [
    { name: "ë‚˜ë¬´ ë§‰ëŒ€", minLv: 1,  color: "#caa46a" },
    { name: "ë‹¨ë‹¨í•œ ëª½ë‘¥ì´", minLv: 5, color: "#d5b17a" },
    { name: "ê°•í™” ëª½ë‘¥ì´", minLv: 10, color: "#b88a54" },
    { name: "ì² í…Œ ëª½ë‘¥ì´", minLv: 15, color: "#a7b0c5" },
    { name: "ê°€ì‹œ ëª½ë‘¥ì´", minLv: 20, color: "#c2c2c2" },
    { name: "ë£¬ ê°ì¸ ëª½ë‘¥ì´", minLv: 30, color: "#6aa7ff" },
  ];

  const SHOP_ITEMS = [
    {
      id: "tape",
      name: "ê°•í™” í…Œì´í”„",
      desc: "ìµœëŒ€ ë‚´êµ¬ë„ +25, ìˆ˜ë¦¬ë¹„ -5%",
      baseCost: 60,
      growth: 1.35,
      max: 10,
      apply(state, n){
        state.stick.maxDur += 25;
        state.economy.repairDiscount = clamp(state.economy.repairDiscount + 0.05, 0, 0.40);
      }
    },
    {
      id: "iron",
      name: "ì‡ í…Œë‘ë¦¬",
      desc: "ê³µê²©ë ¥ +2 (êµ¬ë§¤ë§ˆë‹¤ ëˆ„ì )",
      baseCost: 90,
      growth: 1.40,
      max: 12,
      apply(state, n){
        state.stick.power += 2;
      }
    },
    {
      id: "nails",
      name: "ëª» ë°•ê¸°",
      desc: "ì¹˜ëª…íƒ€ í™•ë¥  +2%",
      baseCost: 140,
      growth: 1.45,
      max: 10,
      apply(state, n){
        state.stick.critChance = clamp(state.stick.critChance + 0.02, 0.05, 0.45);
      }
    },
    {
      id: "oil",
      name: "ìœ¤í™œì œ",
      desc: "ê³µê²©ì†ë„ +0.06",
      baseCost: 170,
      growth: 1.45,
      max: 10,
      apply(state, n){
        state.stick.speed += 0.06;
      }
    },
    {
      id: "rune",
      name: "ë§ˆë²• ë£¬",
      desc: "ì¹˜ëª…íƒ€ ë°°ìˆ˜ +0.1, ì ¬ 1ê°œ ì†Œëª¨",
      baseCost: 0,
      growth: 1,
      max: 12,
      special: "gems",
      gemCost: (owned) => 1,
      apply(state, n){
        state.stick.critMult += 0.10;
      }
    },
    {
      id: "badge",
      name: "ìš©ì‚¬ ë°°ì§€",
      desc: "ëª…ì„± +3, ì „íˆ¬ ë³´ìƒ ì½”ì¸ +3%",
      baseCost: 240,
      growth: 1.55,
      max: 15,
      apply(state, n){
        state.resources.fame += 3;
        state.economy.rewardBonus = clamp(state.economy.rewardBonus + 0.03, 0, 0.60);
      }
    },
  ];

  const ACHIEVEMENTS = [
    { id:"lv5",  name:"ì²« ì„±ì¥",        desc:"ë ˆë²¨ 5 ë‹¬ì„±",      check:s=>s.stick.level>=5,  reward:{coins:120} },
    { id:"lv10", name:"ì œë²• ëª½ë‘¥ì´",     desc:"ë ˆë²¨ 10 ë‹¬ì„±",     check:s=>s.stick.level>=10, reward:{gems:1} },
    { id:"lv20", name:"ì§„ì§œ ëª½ë‘¥ì´",     desc:"ë ˆë²¨ 20 ë‹¬ì„±",     check:s=>s.stick.level>=20, reward:{coins:900, gems:1} },
    { id:"win10",name:"ì „íˆ¬ì˜ ê°ê°",     desc:"ì „íˆ¬ 10ìŠ¹",        check:s=>s.stats.wins>=10,  reward:{coins:350} },
    { id:"win30",name:"ë² í…Œë‘",          desc:"ì „íˆ¬ 30ìŠ¹",        check:s=>s.stats.wins>=30,  reward:{gems:2} },
    { id:"train200",name:"ì—°ë§ˆ ì¥ì¸",    desc:"ì—°ë§ˆ 200íšŒ",       check:s=>s.stats.trains>=200,reward:{coins:600} },
    { id:"rich", name:"ì£¼ë¨¸ë‹ˆê°€ ë¬µì§",   desc:"ì½”ì¸ 5,000 ë³´ìœ ",  check:s=>s.resources.coins>=5000, reward:{gems:1} },
  ];

  function defaultState(){
    return {
      version: 1,
      resources: { coins: 0, gems: 0, fame: 0 },
      stick: {
        level: 1,
        xp: 0,
        power: 1,
        speed: 1.00,        // attacks per second baseline
        critChance: 0.05,
        critMult: 1.50,
        dur: 100,
        maxDur: 100,
      },
      shopOwned: {}, // id -> count
      economy: {
        rewardBonus: 0,        // extra coin reward %
        repairDiscount: 0,     // repair cost discount %
      },
      battle: {
        inBattle: false,
        enemy: null,
        enemyHp: 0,
        enemyMaxHp: 0,
        fleePenalty: 0,
        nextAtkAt: 0,
        nextEnemyAtkAt: 0,
      },
      stats: {
        wins: 0,
        losses: 0,
        trains: 0,
      },
      achClaimed: {}, // id -> true
      log: []
    };
  }

  const SAVE_KEY = "mongdungi_game_save_v1";

  function loadState(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      // ìµœì†Œí•œì˜ ë°©ì–´ì  ë³‘í•©
      const d = defaultState();
      return deepMerge(d, s);
    }catch(e){
      return defaultState();
    }
  }

  function saveState(){
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    $("saveHint").textContent = "ìë™ ì €ì¥ë¨";
    setTimeout(()=> $("saveHint").textContent = "ìë™ ì €ì¥ë¨", 600);
  }

  function deepMerge(base, patch){
    if(typeof base !== "object" || base === null) return patch;
    const out = Array.isArray(base) ? [...base] : {...base};
    for(const k of Object.keys(patch || {})){
      const v = patch[k];
      if(v && typeof v === "object" && !Array.isArray(v) && base[k] && typeof base[k] === "object" && !Array.isArray(base[k])){
        out[k] = deepMerge(base[k], v);
      }else{
        out[k] = v;
      }
    }
    return out;
  }

  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
  function fmt(n){
    // ê°„ë‹¨í•œ í‘œê¸°: 1,234 / 12.3K / 4.5M
    const abs = Math.abs(n);
    if(abs >= 1e9) return (n/1e9).toFixed(2) + "B";
    if(abs >= 1e6) return (n/1e6).toFixed(2) + "M";
    if(abs >= 1e3) return (n/1e3).toFixed(2) + "K";
    return Math.floor(n).toLocaleString("ko-KR");
  }

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=> t.style.display = "none", 1600);
  }

  // ---------- Rendering ----------
  function currentGradeName(lv){
    let g = GRADES[0];
    for(const it of GRADES){
      if(lv >= it.minLv) g = it;
    }
    return g.name;
  }

  function xpToNext(level){
    // ì™„ë§Œí•œ ì¦ê°€
    return Math.floor(10 + Math.pow(level, 1.35) * 7);
  }

  function updateBars(){
    const xpNeed = xpToNext(state.stick.level);
    const xpPct = clamp((state.stick.xp / xpNeed) * 100, 0, 100);
    $("xpBar").querySelector("i").style.width = xpPct.toFixed(1) + "%";
    $("xpTxt").textContent = `${Math.floor(state.stick.xp)} / ${xpNeed}`;

    const durPct = clamp((state.stick.dur / state.stick.maxDur) * 100, 0, 100);
    const durBar = $("durBar");
    durBar.querySelector("i").style.width = durPct.toFixed(1) + "%";
    durBar.classList.remove("good","warn","bad");
    if(durPct >= 55) durBar.classList.add("good");
    else if(durPct >= 25) durBar.classList.add("warn");
    else durBar.classList.add("bad");

    if(state.battle.enemy){
      const ePct = clamp((state.battle.enemyHp / state.battle.enemyMaxHp)*100, 0, 100);
      $("enemyBar").querySelector("i").style.width = ePct.toFixed(1) + "%";
      $("enemyHpTxt").textContent = `${Math.max(0, Math.floor(state.battle.enemyHp))} / ${state.battle.enemyMaxHp}`;
    }else{
      $("enemyBar").querySelector("i").style.width = "0%";
      $("enemyHpTxt").textContent = "-";
    }
  }

  function setTexts(){
    $("coins").textContent = fmt(state.resources.coins);
    $("gems").textContent  = fmt(state.resources.gems);
    $("fame").textContent  = fmt(state.resources.fame);

    $("grade").textContent = currentGradeName(state.stick.level);
    $("level").textContent = String(state.stick.level);
    $("power").textContent = fmt(state.stick.power);
    $("speed").textContent = state.stick.speed.toFixed(2);
    $("crit").textContent  = `${Math.round(state.stick.critChance*100)}% Ã—${state.stick.critMult.toFixed(1)}`;
    $("durTxt").textContent = `${Math.floor(state.stick.dur)}/${state.stick.maxDur}`;

    if(state.battle.enemy){
      $("enemyName").textContent = state.battle.enemy.name;
    }else{
      $("enemyName").textContent = "-";
    }

    // ë²„íŠ¼ ìƒíƒœ
    $("btnTrain").disabled = state.stick.dur <= 0 || state.battle.inBattle;
    $("btnRest").disabled  = state.battle.inBattle;
    $("btnBattle").disabled = state.battle.inBattle || state.stick.dur <= 0;
    $("btnFlee").disabled = !state.battle.inBattle;

    // ë¡œê·¸
    const logEl = $("log");
    logEl.innerHTML = state.log.slice(-120).map(line => `<p>${line}</p>`).join("");
    logEl.scrollTop = logEl.scrollHeight;

    // ì—…ì 
    const total = ACHIEVEMENTS.length;
    const done = ACHIEVEMENTS.filter(a => !!state.achClaimed[a.id]).length;
    $("achCount").textContent = `${done}/${total}`;
  }

  function addLog(tag, msg){
    const color = tag === "ì „íˆ¬" ? "#ffcd4a" : tag === "ì„±ì¥" ? "#45d483" : tag === "ìƒì " ? "#6aa7ff" : "#a9b6d6";
    state.log.push(`<span class="tag" style="color:${color}; border-color:rgba(255,255,255,.10)">${tag}</span>${msg}`);
  }

  // ---------- Canvas Drawing ----------
  function drawStick(){
    const cv = $("cv");
    const ctx = cv.getContext("2d");
    const W = cv.width, H = cv.height;
    ctx.clearRect(0,0,W,H);

    // Glow background particles
    ctx.save();
    for(let i=0;i<18;i++){
      const x = (Math.sin(i*12.3 + state.stick.level)*0.5+0.5)*W;
      const y = (Math.cos(i*9.7 + state.stick.level*0.7)*0.5+0.5)*H;
      const r = 4 + (i%4);
      ctx.globalAlpha = 0.08;
      ctx.beginPath();
      ctx.arc(x,y,r,0,Math.PI*2);
      ctx.fillStyle = "#ffffff";
      ctx.fill();
    }
    ctx.restore();

    // Stick
    const grade = GRADES.reduce((a,g)=> state.stick.level>=g.minLv?g:a, GRADES[0]);
    const baseColor = grade.color;

    // body
    ctx.save();
    ctx.translate(W/2, H/2+20);
    ctx.rotate(-0.45);

    // shadow
    ctx.globalAlpha = 0.18;
    roundRect(ctx, -26, -110, 52, 210, 22);
    ctx.fillStyle = "#000";
    ctx.fill();
    ctx.globalAlpha = 1;

    // wood body
    const bodyW = 44, bodyH = 200;
    roundRect(ctx, -bodyW/2, -bodyH/2, bodyW, bodyH, 20);
    ctx.fillStyle = baseColor;
    ctx.fill();

    // grain lines
    ctx.globalAlpha = 0.18;
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 3;
    for(let i=-14;i<=14;i+=7){
      ctx.beginPath();
      ctx.moveTo(i, -88);
      ctx.quadraticCurveTo(i+6, -20, i-4, 50);
      ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // upgrades visuals
    const owned = state.shopOwned;

    // iron rings (iron)
    if((owned.iron||0) > 0){
      ctx.fillStyle = "rgba(220,230,255,.85)";
      for(let k=0;k<Math.min(3, owned.iron);k++){
        const y = -70 + k*55;
        roundRect(ctx, -28, y, 56, 14, 8);
        ctx.fill();
      }
    }

    // nails/spikes
    if((owned.nails||0) > 0){
      ctx.fillStyle = "rgba(255,255,255,.9)";
      const spikes = Math.min(10, 3 + (owned.nails||0));
      for(let i=0;i<spikes;i++){
        const y = -80 + i*18;
        ctx.beginPath();
        ctx.moveTo(22, y);
        ctx.lineTo(38, y+6);
        ctx.lineTo(22, y+12);
        ctx.closePath();
        ctx.fill();
      }
    }

    // tape
    if((owned.tape||0) > 0){
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = "rgba(255,205,74,.75)";
      const wraps = Math.min(4, 1 + Math.floor((owned.tape||0)/2));
      for(let i=0;i<wraps;i++){
        const y = 20 + i*26;
        roundRect(ctx, -30, y, 60, 12, 8);
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    // rune glow
    if((owned.rune||0) > 0){
      ctx.save();
      ctx.globalAlpha = 0.25;
      ctx.fillStyle = "#6aa7ff";
      for(let i=0;i<6;i++){
        const y = -30 + i*26;
        ctx.beginPath();
        ctx.arc(0,y,10,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();

      ctx.save();
      ctx.strokeStyle = "rgba(106,167,255,.9)";
      ctx.lineWidth = 2;
      for(let i=0;i<4;i++){
        const y = -20 + i*40;
        ctx.beginPath();
        ctx.moveTo(-10,y); ctx.lineTo(10,y);
        ctx.moveTo(0,y-10); ctx.lineTo(0,y+10);
        ctx.stroke();
      }
      ctx.restore();
    }

    ctx.restore();

    // title small
    ctx.save();
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = "rgba(255,255,255,.8)";
    ctx.font = "700 16px system-ui, sans-serif";
    ctx.fillText("Lv." + state.stick.level, 14, 26);
    ctx.globalAlpha = 0.8;
    ctx.font = "12px system-ui, sans-serif";
    ctx.fillText(currentGradeName(state.stick.level), 14, 46);
    ctx.restore();
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // ---------- Mechanics ----------
  function levelUpIfNeeded(){
    let leveled = false;
    while(true){
      const need = xpToNext(state.stick.level);
      if(state.stick.xp < need) break;

      state.stick.xp -= need;
      state.stick.level += 1;

      // ë ˆë²¨ì—… ë³´ìƒ: ê¸°ë³¸ ìŠ¤íƒ¯ ì†Œí­ ì¦ê°€
      state.stick.power += 1 + Math.floor(state.stick.level/6);
      state.stick.maxDur += 6 + Math.floor(state.stick.level/4);
      state.stick.dur = clamp(state.stick.dur + Math.floor(state.stick.maxDur*0.25), 0, state.stick.maxDur);

      // ë‚®ì€ í™•ë¥  ì ¬ ë“œë
      if(Math.random() < 0.08){
        state.resources.gems += 1;
        addLog("ì„±ì¥", `ë ˆë²¨ì—… ë³´ë„ˆìŠ¤ë¡œ ğŸ’ ì ¬ 1ê°œë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤!`);
      }

      addLog("ì„±ì¥", `ë ˆë²¨ ${state.stick.level} ë‹¬ì„±! ê³µê²©ë ¥/ìµœëŒ€ë‚´êµ¬ë„ ìƒìŠ¹`);
      leveled = true;
    }
    if(leveled) toast("ë ˆë²¨ì—…!");
  }

  function train(){
    if(state.battle.inBattle) return;
    if(state.stick.dur <= 0){
      toast("ë‚´êµ¬ë„ê°€ 0ì´ë¼ ì—°ë§ˆí•  ìˆ˜ ì—†ì–´ìš”. ìˆ˜ë¦¬í•˜ì„¸ìš”.");
      return;
    }

    state.stats.trains += 1;

    // ì—°ë§ˆ ë³´ìƒ: ì†ŒëŸ‰ ê³µê²©ë ¥ ì„±ì¥ + ê²½í—˜ì¹˜
    const gainXp = (2 + Math.random()*2) * 3;
    state.stick.xp += gainXp;

    // ì—°ë§ˆë¡œ ê³µê²©ë ¥ ì„±ì¥(ì™„ë§Œ)
    const powGain = 0.18 + Math.sqrt(state.stick.level)*0.03;
    state.stick.power += powGain;

    // ë‚´êµ¬ë„ ì†Œëª¨
    const costDur = 3 + Math.floor(state.stick.level/8);
    state.stick.dur = clamp(state.stick.dur - costDur, 0, state.stick.maxDur);

    addLog("ì—°ë§ˆ", `ì—°ë§ˆ! ê³µê²©ë ¥ +${powGain.toFixed(2)}, ê²½í—˜ì¹˜ +${Math.floor(gainXp)} (ë‚´êµ¬ë„ -${costDur})`);

    levelUpIfNeeded();
    checkAchievements();
    saveState();
    render();
  }

  function repair(){
    if(state.battle.inBattle) return;

    const missing = state.stick.maxDur - state.stick.dur;
    if(missing <= 0){
      toast("ì´ë¯¸ ë‚´êµ¬ë„ê°€ ê°€ë“í•´ìš”.");
      return;
    }

    // ìˆ˜ë¦¬ë¹„: ê²°ì† ë‚´êµ¬ë„ ë¹„ë¡€ + ë ˆë²¨
    const base = Math.ceil(missing * (0.65 + state.stick.level*0.02));
    const discounted = Math.ceil(base * (1 - state.economy.repairDiscount));

    if(state.resources.coins < discounted){
      toast(`ì½”ì¸ì´ ë¶€ì¡±í•´ìš”. í•„ìš”: ${discounted.toLocaleString("ko-KR")}`);
      return;
    }

    state.resources.coins -= discounted;
    state.stick.dur = state.stick.maxDur;

    addLog("ì—°ë§ˆ", `ìˆ˜ë¦¬ ì™„ë£Œ! ë‚´êµ¬ë„ ì „ë¶€ íšŒë³µ (ë¹„ìš© ğŸª™ ${discounted.toLocaleString("ko-KR")})`);
    toast("ìˆ˜ë¦¬ ì™„ë£Œ");
    checkAchievements();
    saveState();
    render();
  }

  function makeEnemy(){
    // ë ˆë²¨ ê¸°ë°˜ ë‚œì´ë„
    const lv = state.stick.level;
    const tier = Math.floor((lv-1)/5);
    const names = [
      ["ì ¤ë¦¬ ìŠ¬ë¼ì„","ì´ˆë³´ ë„ì ","ì•¼ìƒ í† ë¼"],
      ["ì‚°ì ","ë…ë²„ì„¯","ë°”ìœ„ ê³¨ë ˜"],
      ["ê·¸ë¦¼ì ëŠ‘ëŒ€","ë¶ˆê½ƒ ì„í”„","ì² ê°‘ ìŠ¬ë¼ì„"],
      ["ì‹¬ì—° ê¸°ì‚¬","ë£¬ ë¹„ìŠ¤íŠ¸","í­ì£¼ ê³¨ë ˜"],
    ];
    const list = names[Math.min(names.length-1, tier)];
    const name = list[Math.floor(Math.random()*list.length)];

    // ì  ì²´ë ¥/ê³µê²©ë ¥
    const hp = Math.floor(40 + lv*14 + Math.pow(lv, 1.22)*6);
    const atk = Math.max(1, Math.floor(3 + lv*1.4 + tier*3));
    const rewardCoins = Math.floor(25 + lv*12 + tier*30);
    const rewardXp = Math.floor((8 + lv*3) * 1.5);

    return { name, hp, atk, rewardCoins, rewardXp, tier };
  }

  function startBattle(){
    if(state.battle.inBattle) return;
    if(state.stick.dur <= 0){
      toast("ë‚´êµ¬ë„ê°€ 0ì´ë¼ ì „íˆ¬í•  ìˆ˜ ì—†ì–´ìš”. ìˆ˜ë¦¬í•˜ì„¸ìš”.");
      return;
    }

    const enemy = makeEnemy();
    state.battle.inBattle = true;
    state.battle.enemy = enemy;
    state.battle.enemyHp = enemy.hp;
    state.battle.enemyMaxHp = enemy.hp;
    state.battle.fleePenalty = 0;
    const now = performance.now();
    state.battle.nextAtkAt = now + 500;
    state.battle.nextEnemyAtkAt = now + 800;

    addLog("ì „íˆ¬", `${enemy.name} ë“±ì¥! (HP ${enemy.hp}, ATK ${enemy.atk})`);
    toast("ì „íˆ¬ ì‹œì‘!");
    saveState();
    render();
  }

  function flee(){
    if(!state.battle.inBattle) return;
    state.battle.fleePenalty = 0.55; // ë³´ìƒ 55% ê°ì†Œ
    addLog("ì „íˆ¬", `ë„ë§ì³¤ìŠµë‹ˆë‹¤! (ë³´ìƒ í¬ê²Œ ê°ì†Œ)`);
    endBattle(false, true);
  }

  function rollCrit(){
    return Math.random() < state.stick.critChance;
  }

  function battleTick(now){
    if(!state.battle.inBattle || !state.battle.enemy) return;

    // í”Œë ˆì´ì–´ ê³µê²©
    const atkInterval = 1000 / Math.max(0.2, state.stick.speed);
    if(now >= state.battle.nextAtkAt){
      state.battle.nextAtkAt = now + atkInterval;

      let dmg = state.stick.power;
      const crit = rollCrit();
      if(crit) dmg *= state.stick.critMult;

      dmg = Math.max(1, Math.floor(dmg));
      state.battle.enemyHp -= dmg;

      addLog("ì „íˆ¬", `ê³µê²©! ${crit ? "ì¹˜ëª…íƒ€!! " : ""}ì ì—ê²Œ ${dmg} í”¼í•´`);

      if(state.battle.enemyHp <= 0){
        endBattle(true, false);
        return;
      }
    }

    // ì  ê³µê²© (ë‚´êµ¬ë„ ê°ì†Œ)
    const enemyInterval = 1200;
    if(now >= state.battle.nextEnemyAtkAt){
      state.battle.nextEnemyAtkAt = now + enemyInterval;

      const e = state.battle.enemy;
      const dmgToDur = e.atk + Math.floor(e.tier*1.5);
      state.stick.dur = clamp(state.stick.dur - dmgToDur, 0, state.stick.maxDur);

      addLog("ì „íˆ¬", `í”¼ê²©! ë‚´êµ¬ë„ -${dmgToDur}`);

      if(state.stick.dur <= 0){
        endBattle(false, false);
        return;
      }
    }
  }

  function endBattle(victory, fled){
    const e = state.battle.enemy;
    if(!e){ resetBattle(); return; }

    if(victory){
      state.stats.wins += 1;

      let coins = e.rewardCoins;
      coins = Math.floor(coins * (1 + state.economy.rewardBonus));
      if(state.battle.fleePenalty) coins = Math.floor(coins * (1 - state.battle.fleePenalty));

      let xp = e.rewardXp;
      if(state.battle.fleePenalty) xp = Math.floor(xp * (1 - state.battle.fleePenalty));

      state.resources.coins += coins;
      state.stick.xp += xp;

      // ì ¬ ë“œë(ì†Œí™•ë¥ )
      const gemDrop = Math.random() < (0.08 + Math.min(0.12, state.resources.fame/1000));
      if(gemDrop){
        state.resources.gems += 1;
        addLog("ì „íˆ¬", `ì „ë¦¬í’ˆìœ¼ë¡œ ğŸ’ ì ¬ 1ê°œ íšë“!`);
      }

      // ëª…ì„± ì•½ê°„
      const fameGain = 1 + Math.floor(e.tier/2);
      state.resources.fame += fameGain;

      addLog("ì „íˆ¬", `ìŠ¹ë¦¬! ë³´ìƒ: ğŸª™ ${coins.toLocaleString("ko-KR")}, XP ${xp}, â­ ${fameGain}`);
      toast("ìŠ¹ë¦¬!");
      levelUpIfNeeded();
    }else{
      state.stats.losses += 1;
      if(fled){
        addLog("ì „íˆ¬", `íŒ¨ë°° ì²˜ë¦¬(ë„ì£¼). ë‹¤ìŒì—” ë” ê°•í•´ì ¸ì„œ ì˜¤ì!`);
        toast("ë„ì£¼!");
      }else{
        addLog("ì „íˆ¬", `íŒ¨ë°°â€¦ ë‚´êµ¬ë„ê°€ 0ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë¦¬ í›„ ì¬ë„ì „!`);
        toast("íŒ¨ë°°â€¦");
      }
    }

    resetBattle();
    checkAchievements();
    saveState();
    render();
  }

  function resetBattle(){
    state.battle.inBattle = false;
    state.battle.enemy = null;
    state.battle.enemyHp = 0;
    state.battle.enemyMaxHp = 0;
    state.battle.fleePenalty = 0;
  }

  function buyItem(itemId){
    const item = SHOP_ITEMS.find(x => x.id === itemId);
    if(!item) return;

    const owned = state.shopOwned[itemId] || 0;
    if(owned >= item.max){
      toast("ìµœëŒ€ êµ¬ë§¤ íšŸìˆ˜ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.");
      return;
    }

    // cost
    if(item.special === "gems"){
      const needG = item.gemCost(owned);
      if(state.resources.gems < needG){
        toast(`ì ¬ì´ ë¶€ì¡±í•´ìš”. í•„ìš”: ${needG}`);
        return;
      }
      state.resources.gems -= needG;
      state.shopOwned[itemId] = owned + 1;
      item.apply(state, owned + 1);
      addLog("ìƒì ", `${item.name} êµ¬ë§¤! (ğŸ’ -${needG})`);
      toast("êµ¬ë§¤ ì™„ë£Œ");
    }else{
      const cost = Math.floor(item.baseCost * Math.pow(item.growth, owned));
      if(state.resources.coins < cost){
        toast(`ì½”ì¸ì´ ë¶€ì¡±í•´ìš”. í•„ìš”: ${cost.toLocaleString("ko-KR")}`);
        return;
      }
      state.resources.coins -= cost;
      state.shopOwned[itemId] = owned + 1;
      item.apply(state, owned + 1);
      addLog("ìƒì ", `${item.name} êµ¬ë§¤! (ğŸª™ -${cost.toLocaleString("ko-KR")})`);
      toast("êµ¬ë§¤ ì™„ë£Œ");
    }

    // ë‚´êµ¬ë„ ìƒí•œ ëŠ˜ì–´ë‚˜ë©´ í˜„ì¬ ë‚´êµ¬ë„ë„ ì•½ê°„ ë³´ì •
    state.stick.dur = clamp(state.stick.dur, 0, state.stick.maxDur);

    checkAchievements();
    saveState();
    render();
  }

  function buildShop(){
    const wrap = $("shop");
    wrap.innerHTML = "";
    for(const it of SHOP_ITEMS){
      const owned = state.shopOwned[it.id] || 0;

      let costText = "";
      let canBuy = owned < it.max;

      if(it.special === "gems"){
        const gNeed = it.gemCost(owned);
        costText = `ë¹„ìš©: ğŸ’ ${gNeed} | ë³´ìœ : ${state.resources.gems}`;
        if(state.resources.gems < gNeed) canBuy = false;
      }else{
        const cost = Math.floor(it.baseCost * Math.pow(it.growth, owned));
        costText = `ë¹„ìš©: ğŸª™ ${cost.toLocaleString("ko-KR")} | ë³´ìœ : ${state.resources.coins.toLocaleString("ko-KR")}`;
        if(state.resources.coins < cost) canBuy = false;
      }

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="info">
          <div class="name">${it.name} <span class="mini mono">(${owned}/${it.max})</span></div>
          <div class="desc">${it.desc}</div>
          <div class="cost mono">${costText}</div>
        </div>
        <button class="buy ${canBuy ? "accent" : ""}" ${canBuy ? "" : "disabled"}>êµ¬ë§¤</button>
      `;
      div.querySelector("button").addEventListener("click", () => buyItem(it.id));
      wrap.appendChild(div);
    }
  }

  function checkAchievements(){
    for(const a of ACHIEVEMENTS){
      if(state.achClaimed[a.id]) continue;
      if(!a.check(state)) continue;

      state.achClaimed[a.id] = true;

      if(a.reward.coins) state.resources.coins += a.reward.coins;
      if(a.reward.gems)  state.resources.gems  += a.reward.gems;
      if(a.reward.fame)  state.resources.fame  += a.reward.fame;

      const parts = [];
      if(a.reward.coins) parts.push(`ğŸª™ ${a.reward.coins.toLocaleString("ko-KR")}`);
      if(a.reward.gems)  parts.push(`ğŸ’ ${a.reward.gems}`);
      if(a.reward.fame)  parts.push(`â­ ${a.reward.fame}`);
      addLog("ì„±ì¥", `ì—…ì  ë‹¬ì„±: <b>${a.name}</b> (ë³´ìƒ: ${parts.join(", ")})`);
      toast("ì—…ì  ë‹¬ì„±!");
    }
  }

  function buildAchievements(){
    const wrap = $("achs");
    wrap.innerHTML = "";
    for(const a of ACHIEVEMENTS){
      const claimed = !!state.achClaimed[a.id];
      const ok = a.check(state);
      const reward = [];
      if(a.reward.coins) reward.push(`ğŸª™${a.reward.coins}`);
      if(a.reward.gems)  reward.push(`ğŸ’${a.reward.gems}`);
      if(a.reward.fame)  reward.push(`â­${a.reward.fame}`);
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="info">
          <div class="name">${claimed ? "âœ…" : ok ? "ğŸŸ¨" : "â¬œ"} ${a.name}</div>
          <div class="desc">${a.desc}</div>
          <div class="cost mono">ë³´ìƒ: ${reward.join(" ")}</div>
        </div>
        <div class="mini mono" style="min-width:90px; text-align:right;">
          ${claimed ? "ì™„ë£Œ" : ok ? "ë‹¬ì„±!" : "ì§„í–‰ì¤‘"}
        </div>
      `;
      wrap.appendChild(div);
    }
  }

  // ---------- Import/Export/Reset ----------
  function exportSave(){
    const data = JSON.stringify(state);
    navigator.clipboard?.writeText(data).then(()=>{
      toast("í´ë¦½ë³´ë“œì— ì €ì¥ ë°ì´í„° ë³µì‚¬ ì™„ë£Œ!");
    }).catch(()=>{
      prompt("ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ë³´ê´€í•˜ì„¸ìš”.", data);
    });
  }

  function importSave(){
    const raw = prompt("ì €ì¥ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (JSON).");
    if(!raw) return;
    try{
      const parsed = JSON.parse(raw);
      state = deepMerge(defaultState(), parsed);
      saveState();
      addLog("ì„±ì¥", `ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ`);
      toast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
      render();
    }catch(e){
      toast("ì €ì¥ ë°ì´í„°ê°€ ì˜¬ë°”ë¥¸ JSONì´ ì•„ë‹™ë‹ˆë‹¤.");
    }
  }

  function resetAll(){
    const ok = confirm("ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)");
    if(!ok) return;
    state = defaultState();
    saveState();
    toast("ì´ˆê¸°í™” ì™„ë£Œ");
    render();
  }

  // ---------- Main Loop ----------
  let state = loadState();

  function render(){
    setTexts();
    updateBars();
    buildShop();
    buildAchievements();
    drawStick();
  }

  // ë²„íŠ¼ ë°”ì¸ë”©
  $("btnTrain").addEventListener("click", train);
  $("btnRest").addEventListener("click", repair);
  $("btnBattle").addEventListener("click", startBattle);
  $("btnFlee").addEventListener("click", flee);
  $("btnExport").addEventListener("click", exportSave);
  $("btnImport").addEventListener("click", importSave);
  $("btnReset").addEventListener("click", resetAll);

  // ìµœì´ˆ ë Œë”
  addLog("ì„±ì¥", `ê²Œì„ ì‹œì‘! <span class="mini">(íŒ: ë¨¼ì € ì—°ë§ˆë¡œ ë ˆë²¨ì„ ì˜¬ë¦¬ê³ , ìƒì ì—ì„œ ê°•í™”í•˜ì„¸ìš”.)</span>`);
  render();
  saveState();

  // ì• ë‹ˆë©”ì´ì…˜/ì „íˆ¬ ë£¨í”„
  function frame(now){
    battleTick(now);
    // ì „íˆ¬ ì¤‘ì—ëŠ” ì£¼ê¸°ì ìœ¼ë¡œ ì €ì¥/ë Œë” (ê³¼ë„í•˜ì§€ ì•Šê²Œ)
    if(state.battle.inBattle){
      render();
      // ìë™ ì €ì¥(ëŠìŠ¨í•˜ê²Œ)
      if(!frame._lastSave || (now - frame._lastSave) > 2000){
        frame._lastSave = now;
        saveState();
      }
    }else{
      // ì „íˆ¬ ì—†ìœ¼ë©´ ê°€ë”ë§Œ ë Œë”(ì—…ì /ë°” ë³´ì •)
      if(!frame._lastIdle || (now - frame._lastIdle) > 1200){
        frame._lastIdle = now;
        render();
      }
    }
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

})();
</script>
</body>
</html>



